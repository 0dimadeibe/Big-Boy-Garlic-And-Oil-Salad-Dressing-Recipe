image:
  - Ubuntu
  - Visual Studio 2019

environment:
  matrix:
    - BUILD_TYPE: Debug
    - BUILD_TYPE: Release

install:
  - sh: sudo add-apt-repository ppa:hnakamur/icu
  - sh: sudo add-apt-repository ppa:hnakamur/boost
  - sh: sudo apt update
  - sh: sudo apt install -y cmake libssl-dev libavdevice-dev libboost-thread1.67-dev libboost-filesystem1.67-dev libboost-log1.67-dev libpulse-dev libopus-dev libxtst-dev libx11-dev libxfixes-dev libevdev-dev libxcb1-dev libxcb-shm0-dev libxcb-xfixes0-dev
  - sh: sudo update-alternatives --set gcc /usr/bin/gcc-8
  - cmd: C:\msys64\usr\bin\bash -lc "pacman --needed --noconfirm -S mingw-w64-x86_64-openssl mingw-w64-x86_64-cmake mingw-w64-x86_64-toolchain mingw-w64-x86_64-opus mingw-w64-x86_64-x265 mingw-w64-x86_64-boost git yasm nasm diffutils make"

before_build:
  - git submodule update --init --recursive
  - mkdir build
  - cd build

build_script:
  - cmd: C:\msys64\usr\bin\bash -lc "git clone --single-branch --branch stable https://github.com/mirror/x264.git"
  - cmd: C:\msys64\usr\bin\bash -lc "git clone --single-branch --branch Release_3.2 https://github.com/videolan/x265.git"
  - cmd: C:\msys64\usr\bin\bash -lc "git clone --single-branch --branch release/4.2 https://github.com/FFmpeg/FFmpeg.git"
  - cmd: C:\msys64\usr\bin\bash -lc "export PATH=/mingw64/bin:/usr/local/bin:/usr/bin:/bin:/c/Windows/System32:/c/Windows:/c/Windows/System32/Wbem:/c/Windows/System32/WindowsPowerShell/v1.0/:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl && mkdir -p x265/cmake-build && cd x265/cmake-build && cmake -G'Unix Makefiles' ../source && make -j2"
  - cmd: C:\msys64\usr\bin\bash -lc "export PATH=/mingw64/bin:/usr/local/bin:/usr/bin:/bin:/c/Windows/System32:/c/Windows:/c/Windows/System32/Wbem:/c/Windows/System32/WindowsPowerShell/v1.0/:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl && cd x264 && ./configure --enable-static --disable-cli --host=mingw64 && make -j2 && make install"
  - cmd: C:\msys64\usr\bin\bash -lc "export PATH=/mingw64/bin:/usr/local/bin:/usr/bin:/bin:/c/Windows/System32:/c/Windows:/c/Windows/System32/Wbem:/c/Windows/System32/WindowsPowerShell/v1.0/:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl && cd FFmpeg && ./configure --disable-decoders --disable-encoders --disable-hwaccels --disable-doc --disable-programs --enable-static --disable-shared --enable-libx264 --enable-libx265 --enable-nonfree --enable-gpl --extra-cflags=-I../x264 --extra-ldflags=-L../x264 --target-os=mingw64 && make -j2 && make install"
  - cmd: set OLDPATH=%PATH%
  - cmd: set PATH=C:\msys64\mingw64\bin
  - sh: cmake -DCMAKE_BUILD_TYPE=$BUILD_TYPE ..
  - cmd: cmake -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DOPENSSL_ROOT_DIR=C:\OpenSSL-v111-Win64 -DSUNSHINE_STANDALONE=ON -DSUNSHINE_X265_BUILD_DIR=C:\msys64\home\appveyor\x265 -DSUNSHINE_ROOT=. -G "MinGW Makefiles" ..
  - sh: make -j$(nproc)
  - cmd: mingw32-make -j2
  - cmd: set PATH=%OLDPATH%

after_build:
  - cmd: 7z a Sunshine-Windows.zip ..\assets\
  - cmd: 7z a Sunshine-Windows.zip sunshine.exe
  - cmd: 7z a Sunshine-Windows.zip tools\dxgi-info.exe
  - cmd: appveyor PushArtifact Sunshine-Windows.zip
